<div class="row">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-body">
                <form class="form theme-form"  method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-xl-6 col-md-6">
                            <div class="mb-3">
                                <label>患者名称</label>
                               <select class="form-select text-dark" name="name">
                                   {% for user in users %}
                                    <option value="{{ user.name }}">{{ user.name }}</option>
                                   {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-xl-6 col-sm-6">
                            <div class="mb-3">
                                <label>导入图片类型</label>
                                <select class="form-select text-dark" name="imageType">
                                    <option value="心脏">心脏</option>
                                    <option value="肺部">肺部</option>
                                    <option value="椎骨">椎骨</option>
                                    <option value="肺肿瘤">肺肿瘤</option>
                                    <option value="脑肿瘤">脑肿瘤</option>
                                    <option value="多器官">多器官</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-xl-6 col-md-6">
                            <div class="mb-3">
                                <label>病人年龄</label>
                                <select class="form-select text-dark" name="age">
                                   {% for age in ages %}
                                    <option value="{{ age }}">{{ age }}</option>
                                   {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-6">
                            <div class="mb-3">
                                <label>导入时间</label>
                                <input class="datepicker-here form-control text-dark" name="uploadTime" type="text" data-language="en">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="mb-3">
                                <label>请输入病人的详细病情描述</label>
                                <textarea class="form-control text-dark" name="description" id="exampleFormControlTextarea4" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="mb-3">
                                <label>上传病人的医学图片</label>
                                <div class="dropzone" id="medicalPicture">
                                    <div class="dz-message needsclick"><i class="icon-cloud-up"></i>
                                        <h6>拖动文件或者点击上传.</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="text-end">
                                <button type="submit" id="submit" class="btn btn-success me-3" href="/projects">添加</button>
                                <button class="btn btn-danger"  id="clearFormBtn" >清空</button></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    // Dropzone初始化
    Dropzone.autoDiscover = false;
    var myDropzone = new Dropzone("#medicalPicture", {
        url: "/medical", // 上传文件的目标 URL
        method: "post",
        dictDefaultMessage: '拖动文件至此或者点击上传', // 设置默认的提示语句
        dictRemoveFile: "移除文件",
        dictCancelUpload: "取消上传", // 设置取消上传的文本
        paramName: "file", // 传到后台的参数名称
        autoProcessQueue: false, // 关闭自动上传功能
        uploadMultiple: false,
        parallelUploads: 5,
        maxFiles: 5,
        maxFilesize: 1024,
        addRemoveLinks: true,
        dictFallbackMessage: '不好意思，您的浏览器不支持！', // 如果浏览器不支持,默认消息将被替换为这个文本。默认为 “Your browser does not support drag'n'drop file uploads。”。
        dictInvalidFileType: '该文件不允许上传', // 如果文件类型不匹配时显示的错误消息。
        dictResponseError: '上传失败，请稍后重试', // 如果服务器响应是无效的时候显示的错误消息。 {{statusCode}} ` 将被  替换为服务器端返回的状态码。
        init: function () {
            var submitButton = $("#submit");
            var medicalPicture = this; // 保存Dropzone实例的引用
            console.log("上传按钮被点击"); // 添加调试信息
            // 为上传按钮添加点击事件
            submitButton.on("click", function (e) {
                e.preventDefault();
                e.stopPropagation();
                if (medicalPicture.getAcceptedFiles().length !== 0) {
                    medicalPicture.processQueue(); // 手动触发上传队列
                }
            });
            // 在发送文件前将表单数据添加到FormData对象中
            this.on("sending", function (data, xhr, formData) {
                formData.append("name", $("select[name='name']").val());
                formData.append("imageType", $("select[name='imageType']").val());
                formData.append("age", $("select[name='age']").val());
                formData.append("uploadTime", $("input[name='uploadTime']").val());
                formData.append("description", $("textarea[name='description']").val());
            });
            // 上传成功触发的事件
            this.on("success", function (file, data) {
                // 弹窗提示
             alert("上传成功");
                // 清空输入字段
                $(".form-control").val("");
                // 清空 Dropzone 中的文件
                medicalPicture.removeAllFiles(true);
                // 重置下拉菜单的选中项
                $("select").prop("selectedIndex", 0);
            });
        }
    });


    $(document).ready(function() {
        // 为清空按钮添加点击事件监听器
        $("#clearFormBtn").click(function(e) {
            // 阻止表单提交
            e.preventDefault();
            // 清空输入字段
            $(".form-control").val("");
            // 清空 Dropzone 中的文件
            myDropzone.removeAllFiles(true);
            // 重置下拉菜单的选中项
            $("select").prop("selectedIndex", 0);
        });
    });
</script>
